{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///Users/tb/Downloads/HDbank/legal-chatbot/src/app/api/chat-enhanced/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\ninterface Source {\n  id: string | number;\n  title: string;\n  article_reference: string | null;\n  source: string;\n  category: string;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n    const { query, userId } = await request.json()\n\n    if (!query) {\n      return NextResponse.json({ success: false, error: 'Query is required' }, { status: 400 })\n    }\n\n    // 1. Tìm kiếm trong database local trước\n    const { data: localResults, error: localError } = await supabase\n      .from('laws')\n      .select('*')\n      .or(`content.ilike.%${query}%,title.ilike.%${query}%`)\n      .limit(5)\n\n    let sources: Source[] = []\n    let matched_ids: (string | number)[] = []\n    let context = \"\"\n\n    if (!localError && localResults && localResults.length > 0) {\n      // Có kết quả từ database local\n      sources = localResults.map(law => ({\n        id: law.id,\n        title: law.title,\n        article_reference: law.article_reference,\n        source: law.source,\n        category: law.category || 'Local Database'\n      }))\n      \n      matched_ids = localResults.map(law => law.id)\n      \n      context = localResults.map(law => \n        `Tiêu đề: ${law.title}\\n` +\n        `Điều/Khoản: ${law.article_reference || 'N/A'}\\n` +\n        `Nội dung: ${law.content}\\n` +\n        `Nguồn: ${law.source || 'N/A'}\\n`\n      ).join('\\n---\\n')\n    } else {\n      // Không có kết quả từ database local, tìm kiếm từ các nguồn khác\n      const externalResults = await searchExternalSources(query)\n      \n      if (externalResults.length > 0) {\n        sources = externalResults.map(result => ({\n          id: result.id,\n          title: result.title,\n          article_reference: result.article_reference,\n          source: result.source,\n          category: result.category\n        }))\n        \n        matched_ids = externalResults.map(result => result.id)\n        \n        context = externalResults.map(result => \n          `Tiêu đề: ${result.title}\\n` +\n          `Điều/Khoản: ${result.article_reference || 'N/A'}\\n` +\n          `Nội dung: ${result.content}\\n` +\n          `Nguồn: ${result.source}\\n`\n        ).join('\\n---\\n')\n      }\n    }\n\n    // 2. Tạo response dựa trên context\n    let response = \"\"\n    \n    if (context) {\n      response = `Dựa trên các văn bản pháp luật liên quan, tôi có thể trả lời câu hỏi của bạn:\\n\\n${query}\\n\\nThông tin tham khảo từ các nguồn pháp luật:\\n${context}\\n\\nLưu ý: Đây là thông tin tham khảo, bạn nên tham khảo thêm ý kiến của luật sư hoặc cơ quan có thẩm quyền để có lời khuyên chính xác nhất.`\n    } else {\n      response = `Xin lỗi, tôi không tìm thấy thông tin pháp luật cụ thể liên quan đến câu hỏi \"${query}\" trong cơ sở dữ liệu hiện tại. Bạn có thể:\\n\\n1. Thử diễn đạt câu hỏi theo cách khác\\n2. Liên hệ với luật sư để được tư vấn chuyên sâu\\n3. Tham khảo các nguồn pháp luật chính thức như:\\n   - Thư viện Pháp luật (thuvienphapluat.vn)\\n   - Cổng thông tin điện tử Chính phủ (vanban.chinhphu.vn)`\n    }\n\n    // 3. Lưu query log\n    try {\n      await supabase.from('query_logs').insert({\n        query: query,\n        response: response,\n        user_id: userId || null,\n        sources_count: sources.length\n      })\n    } catch (logError) {\n      console.error('Error logging query:', logError)\n    }\n\n    return NextResponse.json({\n      response: response,\n      sources: sources,\n      matched_ids: matched_ids,\n      total_sources: sources.length,\n      search_method: localResults && localResults.length > 0 ? 'local' : 'external'\n    })\n\n  } catch (error) {\n    console.error('Error in enhanced chat:', error)\n    return NextResponse.json({ \n      success: false, \n      error: 'Internal server error',\n      response: 'Xin lỗi, hệ thống đang gặp sự cố. Vui lòng thử lại sau.'\n    }, { status: 500 })\n  }\n}\n\n// Hàm tìm kiếm từ các nguồn bên ngoài\nasync function searchExternalSources(query: string) {\n  const results = []\n\n  try {\n    // Tìm kiếm từ Thư viện Pháp luật\n    const thuvienphapluatResults = await searchThuvienphapluat(query, 3)\n    results.push(...thuvienphapluatResults)\n\n    // Tìm kiếm từ Cổng thông tin điện tử Chính phủ\n    const vanbanchinhphuResults = await searchVanbanchinhphu(query, 3)\n    results.push(...vanbanchinhphuResults)\n\n  } catch (error) {\n    console.error('Error searching external sources:', error)\n  }\n\n  return results\n}\n\n// Hàm tìm kiếm từ Thư viện Pháp luật\nasync function searchThuvienphapluat(query: string, limit: number) {\n  try {\n    // Mock data cho Thư viện Pháp luật\n    const mockResults = [\n      {\n        id: 'tvpl_001',\n        title: 'Luật Ngân hàng Nhà nước Việt Nam số 46/2010/QH12',\n        content: 'Luật này quy định về tổ chức và hoạt động của Ngân hàng Nhà nước Việt Nam, chức năng, nhiệm vụ, quyền hạn của Ngân hàng Nhà nước trong việc quản lý nhà nước về tiền tệ và hoạt động ngân hàng.',\n        article_reference: 'Điều 1, Điều 2, Điều 3',\n        source: 'https://thuvienphapluat.vn/van-ban/Ngan-hang/Luat-Ngan-hang-Nha-nuoc-Viet-Nam-2010-46-2010-QH12-110728.aspx',\n        category: 'Ngân hàng'\n      },\n      {\n        id: 'tvpl_002',\n        title: 'Nghị định 01/2024/NĐ-CP về quy định chi tiết thi hành Luật Các tổ chức tín dụng',\n        content: 'Nghị định này quy định chi tiết thi hành một số điều của Luật Các tổ chức tín dụng số 32/2024/QH15 về điều kiện, thủ tục cấp, sửa đổi, bổ sung, thu hồi giấy phép thành lập và hoạt động của tổ chức tín dụng.',\n        article_reference: 'Điều 6, Điều 7, Điều 8',\n        source: 'https://thuvienphapluat.vn/van-ban/Ngan-hang/Nghi-dinh-01-2024-ND-CP-quy-dinh-chi-tiet-thi-hanh-Luat-Cac-to-chuc-tin-dung-2024-01-2024-ND-CP-678123.aspx',\n        category: 'Ngân hàng'\n      }\n    ]\n\n    return mockResults.filter(result => \n      result.title.toLowerCase().includes(query.toLowerCase()) ||\n      result.content.toLowerCase().includes(query.toLowerCase()) ||\n      result.article_reference.toLowerCase().includes(query.toLowerCase())\n    ).slice(0, limit)\n\n  } catch (error) {\n    console.error('Error searching Thư viện Pháp luật:', error)\n    return []\n  }\n}\n\n// Hàm tìm kiếm từ Cổng thông tin điện tử Chính phủ\nasync function searchVanbanchinhphu(query: string, limit: number) {\n  try {\n    // Mock data cho Cổng thông tin điện tử Chính phủ\n    const mockResults = [\n      {\n        id: 'vbcp_001',\n        title: 'Nghị định 15/2024/NĐ-CP về quy định chi tiết thi hành một số điều của Luật Ngân hàng Nhà nước Việt Nam',\n        content: 'Nghị định này quy định chi tiết thi hành một số điều của Luật Ngân hàng Nhà nước Việt Nam số 46/2010/QH12 về chức năng, nhiệm vụ, quyền hạn của Ngân hàng Nhà nước Việt Nam trong việc quản lý nhà nước về tiền tệ và hoạt động ngân hàng.',\n        article_reference: 'Điều 1, Điều 2, Điều 3',\n        source: 'https://vanban.chinhphu.vn/portal/page/portal/chinhphu/hethongvanban?class_id=1&mode=detail&document_id=200000',\n        category: 'Tài chính - Ngân hàng'\n      },\n      {\n        id: 'vbcp_002',\n        title: 'Luật Các tổ chức tín dụng số 32/2024/QH15',\n        content: 'Luật này quy định về tổ chức và hoạt động của các tổ chức tín dụng; quyền và nghĩa vụ của các tổ chức tín dụng, chi nhánh ngân hàng nước ngoài, văn phòng đại diện của tổ chức tín dụng nước ngoài, tổ chức nước ngoài khác có hoạt động ngân hàng tại Việt Nam.',\n        article_reference: 'Điều 1, Điều 2, Điều 3, Điều 4',\n        source: 'https://vanban.chinhphu.vn/portal/page/portal/chinhphu/hethongvanban?class_id=1&mode=detail&document_id=200002',\n        category: 'Tài chính - Ngân hàng'\n      }\n    ]\n\n    return mockResults.filter(result => \n      result.title.toLowerCase().includes(query.toLowerCase()) ||\n      result.content.toLowerCase().includes(query.toLowerCase()) ||\n      result.article_reference.toLowerCase().includes(query.toLowerCase())\n    ).slice(0, limit)\n\n  } catch (error) {\n    console.error('Error searching Cổng thông tin điện tử Chính phủ:', error)\n    return []\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}