{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 3, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///Users/tb/Downloads/HDbank/legal-chatbot/src/app/api/chat/save-simple/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nexport async function POST(request: NextRequest) {\n  try {\n    // Sử dụng service role key để bypass RLS\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.SUPABASE_SERVICE_ROLE_KEY!\n    )\n\n    const { sessionId, role, content, sources, userId } = await request.json()\n\n    if (!sessionId || !role || !content) {\n      return NextResponse.json({ \n        success: false, \n        error: 'Missing required fields'\n      })\n    }\n\n    // Kiểm tra session có tồn tại không\n    const { data: session, error: sessionError } = await supabase\n      .from('chat_sessions')\n      .select('id')\n      .eq('id', sessionId)\n      .single()\n\n    if (sessionError && sessionError.code === 'PGRST116') {\n      // Session không tồn tại, tạo mới\n      // Tạm thời set user_id = null để bypass foreign key constraint\n      const { error: createSessionError } = await supabase\n        .from('chat_sessions')\n        .insert({\n          id: sessionId,\n          user_id: null, // Tạm thời bypass foreign key\n          title: content.substring(0, 50),\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString()\n        })\n\n      if (createSessionError) {\n        console.error('Error creating session:', createSessionError)\n        return NextResponse.json({ \n          success: false, \n          error: 'Failed to create session',\n          details: createSessionError.message\n        })\n      }\n    }\n\n    // Lưu tin nhắn\n    const { data: newMessage, error: insertError } = await supabase\n      .from('chat_messages')\n      .insert({\n        session_id: sessionId,\n        role,\n        content,\n        sources: sources || null,\n        created_at: new Date().toISOString()\n      })\n      .select()\n      .single()\n\n    if (insertError) {\n      console.error('Error creating chat message:', insertError)\n      return NextResponse.json({ \n        success: false, \n        error: 'Database error',\n        details: insertError.message\n      })\n    }\n\n    return NextResponse.json({\n      success: true,\n      message: newMessage\n    })\n  } catch (error) {\n    console.error('Save simple API error:', error)\n    return NextResponse.json({ \n      success: false, \n      error: (error as Error).message || 'Internal server error'\n    })\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAoB;IAC7C,IAAI;QACF,yCAAyC;QACzC,MAAM,WAAW,IAAA,6NAAY,gFAE3B,QAAQ,GAAG,CAAC,yBAAyB;QAGvC,MAAM,EAAE,SAAS,EAAE,IAAI,EAAE,OAAO,EAAE,OAAO,EAAE,MAAM,EAAE,GAAG,MAAM,QAAQ,IAAI;QAExE,IAAI,CAAC,aAAa,CAAC,QAAQ,CAAC,SAAS;YACnC,OAAO,oKAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;YACT;QACF;QAEA,oCAAoC;QACpC,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,SAClD,IAAI,CAAC,iBACL,MAAM,CAAC,MACP,EAAE,CAAC,MAAM,WACT,MAAM;QAET,IAAI,gBAAgB,aAAa,IAAI,KAAK,YAAY;YACpD,iCAAiC;YACjC,+DAA+D;YAC/D,MAAM,EAAE,OAAO,kBAAkB,EAAE,GAAG,MAAM,SACzC,IAAI,CAAC,iBACL,MAAM,CAAC;gBACN,IAAI;gBACJ,SAAS;gBACT,OAAO,QAAQ,SAAS,CAAC,GAAG;gBAC5B,YAAY,IAAI,OAAO,WAAW;gBAClC,YAAY,IAAI,OAAO,WAAW;YACpC;YAEF,IAAI,oBAAoB;gBACtB,QAAQ,KAAK,CAAC,2BAA2B;gBACzC,OAAO,oKAAY,CAAC,IAAI,CAAC;oBACvB,SAAS;oBACT,OAAO;oBACP,SAAS,mBAAmB,OAAO;gBACrC;YACF;QACF;QAEA,eAAe;QACf,MAAM,EAAE,MAAM,UAAU,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACpD,IAAI,CAAC,iBACL,MAAM,CAAC;YACN,YAAY;YACZ;YACA;YACA,SAAS,WAAW;YACpB,YAAY,IAAI,OAAO,WAAW;QACpC,GACC,MAAM,GACN,MAAM;QAET,IAAI,aAAa;YACf,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,OAAO,oKAAY,CAAC,IAAI,CAAC;gBACvB,SAAS;gBACT,OAAO;gBACP,SAAS,YAAY,OAAO;YAC9B;QACF;QAEA,OAAO,oKAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,SAAS;QACX;IACF,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,0BAA0B;QACxC,OAAO,oKAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,AAAC,MAAgB,OAAO,IAAI;QACrC;IACF;AACF","debugId":null}}]
}